name: LaLiga Data Pipeline & Training

# A. Trigger: Cron Schedule
# Ejecutar Martes y Viernes a las 8:00 AM UTC
on:
  schedule:
    - cron: '0 8 * * 2,5'
  # Permite ejecución manual desde GitHub para pruebas
  workflow_dispatch:

jobs:
  build-and-update:
    runs-on: ubuntu-latest # B. Setup: Ubuntu environment

    steps:
      # 1. Check out del repositorio
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Configurar Python 3.9
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 3. Instalar Chrome y Chromedriver (Necesario para Selenium Headless)
      - name: Install Chrome dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          sudo apt-get install -y xvfb

      # 4. Instalar librerías Python
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 5. C. Run Scraper
      # Extrae datos de Flashscore y Transfermarkt y actualiza /data
      - name: Run Scraper (ETL)
        run: python src/scraper.py
        env:
          User_Agent: "Mozilla/5.0 (LaLigaAI)"

      # --- PASO CRÍTICO (El que causó el conflicto) ---
      - name: Run Feature Engineering
        run: python src/feature_eng.py
      # ----------------------------------------------

      # 6. D. Run Training
      # Lee el CSV nuevo, entrena modelos y guarda model_winner.pkl
      - name: Train Models
        run: python src/models.py

     # 7. E. Git Auto-Commit
      - name: Commit and Push changes
        run: |
          git config --global user.name "LaLiga AI Bot"
          git config --global user.email "bot@laliga-ai.com"
          # Añadir TODO lo que haya en data/ (incluyendo el nuevo fixtures.csv)
          git add data/
          git commit -m "Auto-update: Match results, fixtures and model" || echo "No changes to commit"
          git push
